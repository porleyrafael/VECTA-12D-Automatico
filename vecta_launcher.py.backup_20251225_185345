#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
VECTA 12D LAUNCHER - Sistema Autoprogramable
============================================
Lanzador principal del sistema de 12 dimensiones vectoriales.
"""

import sys
import os
import traceback
from datetime import datetime

# Configurar path para importaciones
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, BASE_DIR)

def mostrar_banner():
    """Muestra el banner de inicio del sistema."""
    print("\n" + "=" * 70)
    print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    print("â•‘                   VECTA 12D - SISTEMA AUTOPROGRAMABLE        â•‘")
    print("â•‘                   12 Dimensiones Vectoriales                 â•‘")
    print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    print("=" * 70)
    print(f"Inicio: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Directorio: {BASE_DIR}")
    print("=" * 70)

def inicializar_sistema():
    """Inicializa y verifica todos los componentes del sistema."""
    print("\n[1/3] ğŸš€ INICIALIZANDO SISTEMA VECTA 12D...")
    
    # Verificar estructura de directorios
    directorios_necesarios = ['core', 'dimensiones']
    for dir_name in directorios_necesarios:
        if not os.path.exists(dir_name):
            print(f"  âŒ ERROR: Directorio '{dir_name}' no encontrado")
            return None
        print(f"  âœ“ Directorio '{dir_name}' encontrado")
    
    # Verificar archivos crÃ­ticos
    archivos_criticos = [
        'core/vecta_12d_core.py',
        'dimensiones/vector_12d.py'
    ]
    
    for archivo in archivos_criticos:
        if not os.path.exists(archivo):
            print(f"  âŒ ERROR: Archivo '{archivo}' no encontrado")
            return None
        print(f"  âœ“ Archivo '{archivo}' encontrado")
    
    return True

def cargar_nucleo():
    """Carga el nÃºcleo principal de VECTA 12D."""
    print("\n[2/3] âš™ï¸ CARGANDO NÃšCLEO VECTA 12D...")
    
    try:
        # Importar nÃºcleo principal
        from core.vecta_12d_core import VECTA_12D_Core
        
        # Crear instancia
        vecta = VECTA_12D_Core()
        
        # Verificar dimensiones
        if hasattr(vecta, 'dimensiones'):
            num_dimensiones = len(vecta.dimensiones)
            print(f"  âœ“ NÃºcleo cargado: {num_dimensiones} dimensiones activas")
        else:
            print(f"  âœ“ NÃºcleo cargado (atributo 'dimensiones' no disponible)")
        
        return vecta
        
    except ImportError as e:
        print(f"  âŒ ERROR de importaciÃ³n: {e}")
        print(f"  Traceback: {traceback.format_exc()}")
        return None
    except Exception as e:
        print(f"  âŒ ERROR inesperado: {e}")
        return None

def cargar_sistema_vectorial():
    """Carga el sistema vectorial 12D."""
    print("\n[3/3] ğŸ”„ CARGANDO SISTEMA VECTORIAL 12D...")
    
    try:
        from dimensiones.vector_12d import SistemaVectorial12D
        
        sistema = SistemaVectorial12D()
        
        # Intentar obtener nÃºmero de dimensiones
        try:
            num_dim = sistema.obtener_numero_dimensiones()
            print(f"  âœ“ Sistema vectorial: {num_dim} dimensiones cargadas")
        except:
            # Si falla, intentar mÃ©todo alternativo
            if hasattr(sistema, 'dimensiones'):
                print(f"  âœ“ Sistema vectorial: {len(sistema.dimensiones)} dimensiones cargadas")
            else:
                print(f"  âœ“ Sistema vectorial cargado (mÃ©todo de conteo no disponible)")
        
        return sistema
        
    except Exception as e:
        print(f"  âš ï¸ Sistema vectorial no disponible: {e}")
        return None

def mostrar_menu_principal():
    """Muestra el menÃº principal de opciones."""
    print("\n" + "â•" * 70)
    print("MENÃš PRINCIPAL - VECTA 12D")
    print("â•" * 70)
    print("1. Procesar texto/comando")
    print("2. Ver estado del sistema")
    print("3. Probar dimensiones individuales")
    print("4. Ejecutar autodiagnÃ³stico")
    print("5. Generar vector 12D aleatorio")
    print("6. Salir del sistema")
    print("â•" * 70)

def procesar_opcion(opcion, vecta, sistema_vectorial):
    """Procesa la opciÃ³n seleccionada del menÃº."""
    
    if opcion == "1":
        # Procesar entrada de texto
        entrada = input("\nğŸ“ Ingrese texto/comando a procesar: ").strip()
        if entrada:
            print(f"\nğŸ”„ Procesando: '{entrada}'")
            try:
                resultado = vecta.procesar(entrada)
                print(f"\nâœ… RESULTADO:")
                print(f"   Entrada: {entrada}")
                print(f"   Salida: {resultado}")
                
                # Si hay sistema vectorial, procesar tambiÃ©n allÃ­
                if sistema_vectorial:
                    evento = {"texto": entrada, "timestamp": datetime.now().isoformat()}
                    vector_resultado = sistema_vectorial.procesar_evento(evento)
                    print(f"   Vector 12D generado: SÃ­")
                    
            except Exception as e:
                print(f"âŒ Error al procesar: {e}")
        else:
            print("âš ï¸ Entrada vacÃ­a, no se procesÃ³ nada")
    
    elif opcion == "2":
        # Ver estado del sistema
        print("\nğŸ“Š ESTADO DEL SISTEMA VECTA 12D")
        print("â”€" * 40)
        print(f"Hora del sistema: {datetime.now().strftime('%H:%M:%S')}")
        print(f"Directorio de trabajo: {BASE_DIR}")
        
        # InformaciÃ³n del nÃºcleo
        if vecta:
            print(f"\nNÃšCLEO VECTA:")
            print(f"  â€¢ Clase: {vecta.__class__.__name__}")
            if hasattr(vecta, 'dimensiones'):
                print(f"  â€¢ Dimensiones activas: {len(vecta.dimensiones)}")
            if hasattr(vecta, 'historial'):
                print(f"  â€¢ Procesamientos en historial: {len(vecta.historial)}")
        
        # InformaciÃ³n del sistema vectorial
        if sistema_vectorial:
            print(f"\nSISTEMA VECTORIAL 12D:")
            print(f"  â€¢ Clase: {sistema_vectorial.__class__.__name__}")
            try:
                num_dim = sistema_vectorial.obtener_numero_dimensiones()
                print(f"  â€¢ Dimensiones cargadas: {num_dim}")
            except:
                if hasattr(sistema_vectorial, 'dimensiones'):
                    print(f"  â€¢ Dimensiones cargadas: {len(sistema_vectorial.dimensiones)}")
    
    elif opcion == "3":
        # Probar dimensiones individuales
        print("\nğŸ”¬ PRUEBA DE DIMENSIONES INDIVIDUALES")
        print("â”€" * 40)
        
        # Listar dimensiones disponibles
        dimensiones_disponibles = []
        for i in range(1, 13):
            dim_path = f"dimensiones/dimension_{i}.py"
            if os.path.exists(dim_path):
                dimensiones_disponibles.append(i)
        
        print(f"Dimensiones encontradas: {dimensiones_disponibles}")
        
        if dimensiones_disponibles:
            try:
                dim_num = int(input("Ingrese nÃºmero de dimensiÃ³n a probar (1-12): "))
                if 1 <= dim_num <= 12:
                    modulo_nombre = f"dimensiones.dimension_{dim_num}"
                    print(f"\nProbando dimensiÃ³n {dim_num}...")
                    
                    # Importar y probar la dimensiÃ³n
                    try:
                        modulo = __import__(modulo_nombre, fromlist=[''])
                        print(f"âœ“ MÃ³dulo cargado: {modulo.__name__}")
                        
                        # Buscar clase principal
                        for attr_name in dir(modulo):
                            if 'Dimension' in attr_name or 'DIM' in attr_name.upper():
                                dim_class = getattr(modulo, attr_name)
                                if isinstance(dim_class, type):  # Es una clase
                                    print(f"âœ“ Clase encontrada: {attr_name}")
                                    break
                        
                    except Exception as e:
                        print(f"âŒ Error al cargar dimensiÃ³n {dim_num}: {e}")
                else:
                    print("âŒ NÃºmero de dimensiÃ³n invÃ¡lido")
            except ValueError:
                print("âŒ Ingrese un nÃºmero vÃ¡lido")
    
    elif opcion == "4":
        # AutodiagnÃ³stico
        print("\nğŸ©º EJECUTANDO AUTODIAGNÃ“STICO...")
        print("â”€" * 40)
        
        # Verificar archivos esenciales
        archivos_esenciales = [
            'vecta_corregido.py',
            'vecta_self_install.py',
            'INSTALAR.bat',
            'core/__init__.py',
            'core/config_manager.py'
        ]
        
        for archivo in archivos_esenciales:
            if os.path.exists(archivo):
                print(f"âœ“ {archivo}")
            else:
                print(f"âœ— {archivo} (NO ENCONTRADO)")
        
        # Contar archivos de dimensiones
        contador_dimensiones = 0
        for i in range(1, 13):
            if os.path.exists(f"dimensiones/dimension_{i}.py"):
                contador_dimensiones += 1
        
        print(f"\nğŸ“ Archivos de dimensiones: {contador_dimensiones}/12")
        
        if contador_dimensiones == 12:
            print("âœ… TODAS las dimensiones estÃ¡n presentes")
        else:
            print(f"âš ï¸ Faltan {12 - contador_dimensiones} dimensiones")
    
    elif opcion == "5":
        # Generar vector aleatorio
        print("\nğŸ² GENERANDO VECTOR 12D ALEATORIO...")
        
        if sistema_vectorial:
            try:
                # Crear evento de prueba
                evento_prueba = {
                    "tipo": "prueba_aleatoria",
                    "timestamp": datetime.now().isoformat(),
                    "datos": {
                        "valor": 42,
                        "texto": "Vector de prueba",
                        "aleatorio": True
                    }
                }
                
                vector = sistema_vectorial.procesar_evento(evento_prueba)
                
                print("âœ… VECTOR 12D GENERADO:")
                if hasattr(vector, 'dimensiones'):
                    for i, dim in enumerate(vector.dimensiones, 1):
                        print(f"   DimensiÃ³n {i:2d}: {type(dim).__name__} = {str(dim)[:50]}...")
                else:
                    print(f"   Resultado: {vector}")
            except Exception as e:
                print(f"âŒ Error generando vector: {e}")
        else:
            print("âŒ Sistema vectorial no disponible")
    
    elif opcion == "6":
        # Salir
        print("\nğŸ‘‹ Cerrando sistema VECTA 12D...")
        return False
    
    else:
        print(f"\nâš ï¸ OpciÃ³n '{opcion}' no vÃ¡lida")
    
    input("\nPresione Enter para continuar...")
    return True

def main():
    """FunciÃ³n principal del lanzador."""
    
    # Mostrar banner
    mostrar_banner()
    
    # Inicializar sistema
    if not inicializar_sistema():
        print("\nâŒ ERROR CRÃTICO: No se puede inicializar el sistema")
        print("   Verifique la estructura de directorios y archivos.")
        input("\nPresione Enter para salir...")
        return 1
    
    # Cargar componentes
    vecta = cargar_nucleo()
    if not vecta:
        print("\nâŒ ERROR: No se pudo cargar el nÃºcleo VECTA 12D")
        input("\nPresione Enter para salir...")
        return 1
    
    sistema_vectorial = cargar_sistema_vectorial()
    
    print("\n" + "=" * 70)
    print("âœ… SISTEMA VECTA 12D INICIALIZADO CORRECTAMENTE")
    print("=" * 70)
    
    # Bucle principal
    ejecutando = True
    while ejecutando:
        try:
            mostrar_menu_principal()
            opcion = input("\nSeleccione una opciÃ³n (1-6): ").strip()
            
            if opcion.lower() in ['exit', 'quit', 'salir']:
                opcion = "6"
            
            ejecutando = procesar_opcion(opcion, vecta, sistema_vectorial)
            
        except KeyboardInterrupt:
            print("\n\nâš ï¸ InterrupciÃ³n recibida (Ctrl+C)")
            confirmar = input("Â¿Desea salir del sistema? (s/n): ").lower()
            if confirmar == 's':
                ejecutando = False
        except Exception as e:
            print(f"\nâŒ ERROR inesperado: {e}")
            print("El sistema se reiniciarÃ¡...")
            import time
            time.sleep(2)
    
    # Mensaje de despedida
    print("\n" + "=" * 70)
    print("VECTA 12D - Sistema cerrado correctamente")
    print(f"Hora de cierre: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 70)
    
    return 0

if __name__ == "__main__":
    try:
        exit_code = main()
        sys.exit(exit_code)
    except Exception as e:
        print(f"ERROR FATAL: {e}")
        traceback.print_exc()
        input("\nPresione Enter para salir...")
        sys.exit(1)